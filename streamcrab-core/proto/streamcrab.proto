syntax = "proto3";

package streamcrab;

service JobManagerService {
  rpc RegisterTaskManager(RegisterTMRequest) returns (RegisterTMResponse);
  rpc Heartbeat(HeartbeatRequest) returns (HeartbeatResponse);
  rpc AckCheckpoint(CheckpointAck) returns (Empty);
  rpc ReportFailure(FailureReport) returns (Empty);
  rpc SubmitJob(SubmitJobRequest) returns (SubmitJobResponse);
  rpc GetJobStatus(GetJobStatusRequest) returns (GetJobStatusResponse);
  rpc TriggerCheckpoint(TriggerCheckpointRequest) returns (TriggerCheckpointResponse);
  rpc ListTaskManagers(ListTaskManagersRequest) returns (ListTaskManagersResponse);
}

service TaskManagerService {
  rpc DeployTask(TaskDeploymentDescriptor) returns (DeploymentResult);
  rpc CancelTask(CancelTaskRequest) returns (Empty);
  rpc TriggerCheckpoint(CheckpointBarrier) returns (Empty);
  rpc NotifyCheckpointComplete(CheckpointComplete) returns (Empty);
}

message Empty {}

message Resources {
  uint32 cpu_cores = 1;
  uint64 memory_mb = 2;
}

message RegisterTMRequest {
  string tm_id = 1;
  string address = 2;
  uint32 num_slots = 3;
  Resources resources = 4;
}

message RegisterTMResponse {
  bool accepted = 1;
  string message = 2;
}

message HeartbeatRequest {
  string tm_id = 1;
  int64 timestamp = 2;
  uint32 queue_usage = 3;
  uint64 throughput = 4;
}

message HeartbeatResponse {
  bool alive = 1;
}

message FailureReport {
  string tm_id = 1;
  string task_id = 2;
  string reason = 3;
}

message CheckpointAck {
  uint64 checkpoint_id = 1;
  string task_id = 2;
  bytes state_bytes = 3;
}

message TaskDeploymentDescriptor {
  string task_id = 1;
  uint32 vertex_id = 2;
  uint32 subtask_index = 3;
  bytes operator_bytes = 4;
  repeated uint32 input_channels = 5;
  repeated uint32 output_channels = 6;
  repeated string output_peer_tms = 7;
}

message DeploymentResult {
  bool success = 1;
  string error_message = 2;
}

message CancelTaskRequest {
  string task_id = 1;
}

message CheckpointBarrier {
  uint64 checkpoint_id = 1;
  int64 timestamp = 2;
  string job_id = 3;
  repeated string task_ids = 4;
}

message CheckpointComplete {
  uint64 checkpoint_id = 1;
}

message SubmitJobRequest {
  bytes job_plan = 1;
  uint32 parallelism = 2;
}

message SubmitJobResponse {
  string job_id = 1;
  bool accepted = 2;
  string error_message = 3;
}

message GetJobStatusRequest {
  string job_id = 1;
}

enum JobStatus {
  JOB_STATUS_UNSPECIFIED = 0;
  JOB_STATUS_CREATED = 1;
  JOB_STATUS_RUNNING = 2;
  JOB_STATUS_FAILED = 3;
  JOB_STATUS_FINISHED = 4;
  JOB_STATUS_CANCELLING = 5;
  JOB_STATUS_CANCELLED = 6;
}

message GetJobStatusResponse {
  string job_id = 1;
  JobStatus status = 2;
  string message = 3;
}

message TriggerCheckpointRequest {
  string job_id = 1;
}

message TriggerCheckpointResponse {
  bool accepted = 1;
  uint64 checkpoint_id = 2;
  string message = 3;
}

message TaskManagerSummary {
  string tm_id = 1;
  string address = 2;
  uint32 num_slots = 3;
  int64 last_heartbeat_unix_ms = 4;
}

message ListTaskManagersRequest {}

message ListTaskManagersResponse {
  repeated TaskManagerSummary task_managers = 1;
}
